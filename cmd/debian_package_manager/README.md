# Debian Package Manager

A debian package index parser with bazel config generation

# Usage

```sh
./debian_package_manager
A debian package index parser with bazel config generation

Usage:
  debian_package_manager [flags]
  debian_package_manager [command]

Available Commands:
  completion  Generate the autocompletion script for the specified shell
  generate    Generate a new configuration for packages and bazel config
  help        Help about any command
  update      Update packages with new versions and bazel config

Flags:
  -h, --help                  help for debian_package_manager
      --packages string       location of packages YAML config file (default "packages.yaml")
      --packages-out string   location to generate BAZEL deb archive repository config (default "packages.bzl")
      --snapshots string      location of snapshots YAML config file (might be overwritten) (default "snapshots.yaml")
      --versions-out string   location to generate BAZEL debian versions configs (default "versions.bzl")

Use "debian_package_manager [command] --help" for more information about a command.
# if new versions are available, update snapshots and bazel config
$ make update
$ ./update

# generate new config for current snapshot
$ make generate
$ ./generate
```

# Arguments

File paths can be specified with the following flags:

```
--packages string       location of packages YAML config file (default "packages.yaml")
--packages-out string   location to generate BAZEL deb archive repository config (default "packages.bzl")
--snapshots string      location of snapshots YAML config file (might be overwritten) (default "snapshots.yaml")
--versions-out string   location to generate BAZEL debian versions configs (default "versions.bzl")
```

### snapshots.yaml (input/output)

Usually autogenerated if none can be found, the debian snapshot version, usually a timestamp
that can be placed in an url like: `https://snapshot.debian.org/archive/debian/20220101T024315Z/`

```yaml
debian: 20220112T093851Z
security: 20220112T153306Z
```

### packages.yaml (input)

A list of packages with architecture and debian distro parameters

```yaml
---
debian_packages:
  distros: ["debian12"]
  archs: ["amd64", "arm64"]
  packages:
    - "ca-certificates"
    - "curl"
```

### packages.bzl (output)

A bazel config of all the parsed packages, packages are `http_file` with name `<arch>_<distro>_<package_name>`, package
names that contain special characters like `+` will be converted into bazel valid names.

This file can be imported into bazel config by adding the following to WORKSPACE

```
load(":packages.bzl", debian_repositories = "repositories")
debian_repositories()
```

a debian file can be referenced by the name of the `http_file`

```
"@amd64_debian12_base-files//file"
```

### versions.bzl (output)

A bazel config file containing a map of packages to their versions. Useful when trying apply a string value of a version
to a rule attribute.

```
DEBIAN_PACKAGE_VERSIONS = {
    "amd64": {
        "debian10": {
            "base-files": "10.3+deb10u11",
            "ca-certificates": "20200601~deb10u2",
            ...
```

This config can be imported in .bzl or BUILD files with

```
load("//:versions.bzl", VERSIONS = "DEBIAN_PACKAGE_VERSIONS")

VERSIONS["amd64"]["debian10"]["base-files"]
```
